<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfraWatch++ | Infrastructure Risk Intelligence</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: #1f2937;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: #2563eb;
        }

        .logo h1 {
            color: #2563eb;
            font-size: 2.5rem;
            font-weight: 800;
        }

        .logo .plus {
            color: #dc2626;
        }

        .tagline {
            color: #6b7280;
            font-size: 1.1rem;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .nav-btn.primary {
            background: #2563eb;
            color: white;
        }

        .nav-btn.secondary {
            background: #dc2626;
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 25px;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-box {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .high-risk { background: linear-gradient(135deg, #fee2e2, #fecaca); border-left: 4px solid #dc2626; }
        .medium-risk { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; }
        .low-risk { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-left: 4px solid #059669; }
        .total-risk { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 4px solid #2563eb; }

        /* Map */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
        }

        /* Asset List */
        .asset-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .asset-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
        }

        .asset-item:hover {
            background: #f8fafc;
            transform: translateX(5px);
        }

        .asset-item.high { border-left-color: #dc2626; }
        .asset-item.medium { border-left-color: #f59e0b; }
        .asset-item.low { border-left-color: #059669; }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .asset-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .risk-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .risk-badge.high { background: #fee2e2; color: #dc2626; }
        .risk-badge.medium { background: #fef3c7; color: #f59e0b; }
        .risk-badge.low { background: #d1fae5; color: #059669; }

        .asset-details {
            font-size: 0.9rem;
            color: #6b7280;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }

        /* Recommendation */
        .recommendation {
            background: #eff6ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .budget-control {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 150px;
        }

        /* Buttons */
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
            margin-top: 15px;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #dc2626;
        }

        .btn-secondary:hover {
            background: #b91c1c;
        }

        /* Disclaimer */
        .disclaimer {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 25px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }

        /* Map Legend */
        .map-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .legend-color.high { background: #dc2626; }
        .legend-color.medium { background: #f59e0b; }
        .legend-color.low { background: #059669; }

        /* Report Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .problem-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .problem-type {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .problem-type:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .problem-type.selected {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .image-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            height: 150px;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 38, 38, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Reports List */
        .reports-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .report-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
            background: #f8fafc;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .report-title {
            font-weight: 600;
            color: #1f2937;
        }

        .report-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-new { background: #dbeafe; color: #1d4ed8; }
        .status-in-progress { background: #fef3c7; color: #d97706; }
        .status-resolved { background: #d1fae5; color: #059669; }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #2563eb;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #059669;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab:hover {
            color: #2563eb;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Navigation -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <div>
                    <h1>InfraWatch<span class="plus">++</span></h1>
                    <p class="tagline">Predictive Infrastructure Risk Intelligence</p>
                </div>
            </div>
            <div class="nav">
                <button class="nav-btn primary" onclick="showDashboard()">
                    <i class="fas fa-dashboard"></i> Dashboard
                </button>
                <button class="nav-btn secondary" onclick="showReportForm()">
                    <i class="fas fa-exclamation-circle"></i> Report Problem
                </button>
                <button class="nav-btn" onclick="showReportsList()" style="background: #059669; color: white;">
                    <i class="fas fa-list-check"></i> View Reports
                </button>
            </div>
        </div>

        <!-- Dashboard View (Default) -->
        <div id="dashboard-view">
            <div class="dashboard">
                <!-- Left Panel -->
                <div class="left-panel">
                    <!-- System Health -->
                    <div class="card">
                        <h2><i class="fas fa-heartbeat"></i> System Health Overview</h2>
                        <div class="stats-grid">
                            <div class="stat-box high-risk">
                                <span class="stat-value" id="high-risk-count">3</span>
                                <span class="stat-label">High Risk Assets</span>
                            </div>
                            <div class="stat-box medium-risk">
                                <span class="stat-value" id="medium-risk-count">2</span>
                                <span class="stat-label">Medium Risk</span>
                            </div>
                            <div class="stat-box low-risk">
                                <span class="stat-value" id="low-risk-count">5</span>
                                <span class="stat-label">Low Risk</span>
                            </div>
                            <div class="stat-box total-risk">
                                <span class="stat-value" id="total-risk">598</span>
                                <span class="stat-label">Total Risk Score</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Recommendation -->
                    <div class="card">
                        <h2><i class="fas fa-robot"></i> AI Recommendation</h2>
                        <p>Fix these assets first to maximize risk reduction:</p>
                        <div id="recommendation" class="recommendation">
                            <!-- Filled by JavaScript -->
                        </div>
                        <div class="budget-control">
                            <label for="budget-slider">Budget (assets to fix):</label>
                            <input type="range" id="budget-slider" min="1" max="5" value="3">
                            <span id="budget-value">3</span>
                        </div>
                        <button id="simulate-btn" class="btn">
                            <i class="fas fa-calculator"></i> Run What-If Simulation
                        </button>
                    </div>

                    <!-- Key Insight -->
                    <div class="card">
                        <h2><i class="fas fa-lightbulb"></i> Key Insight</h2>
                        <p>High-risk bridges are not just old—they suffer from traffic stress, environmental exposure, and maintenance neglect simultaneously.</p>
                        <div class="disclaimer">
                            <i class="fas fa-exclamation-triangle"></i>
                            These scores are estimates based on available data and should be validated by engineers.
                        </div>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="right-panel">
                    <!-- Map -->
                    <div class="card">
                        <h2><i class="fas fa-map-marked-alt"></i> Risk Map</h2>
                        <div id="map"></div>
                        <div class="map-legend">
                            <div class="legend-item">
                                <span class="legend-color high"></span>
                                <span>High Risk (70+)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color medium"></span>
                                <span>Medium (40-69)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color low"></span>
                                <span>Low (0-39)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Asset List -->
                    <div class="card">
                        <h2><i class="fas fa-list"></i> Bridge List</h2>
                        <div id="asset-list" class="asset-list">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Form View (Hidden by Default) -->
        <div id="report-view" style="display: none;">
            <div class="card">
                <h2><i class="fas fa-exclamation-circle"></i> Report Infrastructure Problem</h2>
                
                <div id="report-alert"></div>
                
                <form id="report-form">
                    <!-- Problem Type Selection -->
                    <div class="form-group">
                        <label class="form-label">Select Problem Type *</label>
                        <div class="problem-types">
                            <div class="problem-type" onclick="selectProblemType(this, 'pothole')">
                                <i class="fas fa-road" style="font-size: 24px; margin-bottom: 8px; color: #dc2626;"></i>
                                <div>Potholes</div>
                            </div>
                            <div class="problem-type" onclick="selectProblemType(this, 'crack')">
                                <i class="fas fa-crack" style="font-size: 24px; margin-bottom: 8px; color: #f59e0b;"></i>
                                <div>Cracks & Damage</div>
                            </div>
                            <div class="problem-type" onclick="selectProblemType(this, 'flooding')">
                                <i class="fas fa-water" style="font-size: 24px; margin-bottom: 8px; color: #2563eb;"></i>
                                <div>Flooding Issues</div>
                            </div>
                            <div class="problem-type" onclick="selectProblemType(this, 'safety')">
                                <i class="fas fa-triangle-exclamation" style="font-size: 24px; margin-bottom: 8px; color: #dc2626;"></i>
                                <div>Safety Hazard</div>
                            </div>
                            <div class="problem-type" onclick="selectProblemType(this, 'maintenance')">
                                <i class="fas fa-tools" style="font-size: 24px; margin-bottom: 8px; color: #059669;"></i>
                                <div>Maintenance Needed</div>
                            </div>
                            <div class="problem-type" onclick="selectProblemType(this, 'other')">
                                <i class="fas fa-ellipsis" style="font-size: 24px; margin-bottom: 8px; color: #6b7280;"></i>
                                <div>Other Issue</div>
                            </div>
                        </div>
                        <input type="hidden" id="problem-type" name="problemType" required>
                    </div>

                    <!-- Location Information -->
                    <div class="form-group">
                        <label class="form-label">Location Details *</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <input type="text" class="form-input" id="location-name" placeholder="Location Name (e.g., Main Street Bridge)" required>
                            </div>
                            <div>
                                <input type="text" class="form-input" id="nearest-landmark" placeholder="Nearest Landmark">
                            </div>
                        </div>
                        
                        <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-location-dot" style="color: #2563eb;"></i>
                                <strong>Live Location Capture</strong>
                                <button type="button" onclick="getCurrentLocation()" class="nav-btn" style="padding: 8px 15px; margin-left: auto;">
                                    <i class="fas fa-location-crosshairs"></i> Get Location
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="text" class="form-input" id="latitude" placeholder="Latitude" readonly>
                                <input type="text" class="form-input" id="longitude" placeholder="Longitude" readonly>
                            </div>
                            <div id="location-status" style="margin-top: 10px; font-size: 0.9rem; color: #6b7280;">
                                Click "Get Location" to capture your current coordinates
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label class="form-label">Problem Description *</label>
                        <textarea class="form-textarea" id="description" placeholder="Please describe the problem in detail..." required></textarea>
                    </div>

                    <!-- Image Upload -->
                    <div class="form-group">
                        <label class="form-label">Upload Photos (Optional but helpful)</label>
                        <div class="image-upload-area" onclick="document.getElementById('image-upload').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #9ca3af; margin-bottom: 15px;"></i>
                            <h3 style="color: #374151; margin-bottom: 8px;">Click to upload photos</h3>
                            <p style="color: #6b7280; font-size: 0.9rem;">Upload images of the problem (max 5 images, 5MB each)</p>
                            <input type="file" id="image-upload" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        </div>
                        <div id="image-preview-container" class="image-preview-container">
                            <!-- Image previews will appear here -->
                        </div>
                    </div>

                    <!-- Urgency Level -->
                    <div class="form-group">
                        <label class="form-label">Urgency Level *</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="urgency" value="low" checked>
                                <span style="padding: 8px 16px; background: #d1fae5; color: #059669; border-radius: 8px;">Low</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="urgency" value="medium">
                                <span style="padding: 8px 16px; background: #fef3c7; color: #d97706; border-radius: 8px;">Medium</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="urgency" value="high">
                                <span style="padding: 8px 16px; background: #fee2e2; color: #dc2626; border-radius: 8px;">High</span>
                            </label>
                        </div>
                    </div>

                    <!-- User Information -->
                    <div class="form-group">
                        <label class="form-label">Your Information *</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <input type="text" class="form-input" id="user-name" placeholder="Your Name" required>
                            </div>
                            <div>
                                <input type="email" class="form-input" id="user-email" placeholder="Email Address" required>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <input type="tel" class="form-input" id="user-phone" placeholder="Phone Number">
                            </div>
                            <div>
                                <select class="form-select" id="user-type">
                                    <option value="citizen">Citizen</option>
                                    <option value="engineer">Engineer</option>
                                    <option value="official">Government Official</option>
                                    <option value="driver">Driver/Transport</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="button" class="btn" onclick="showDashboard()" style="background: #6b7280;">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </button>
                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-paper-plane"></i> Submit Report
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reports List View (Hidden by Default) -->
        <div id="reports-view" style="display: none;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-list-check"></i> Recent Reports</h2>
                    <button class="nav-btn primary" onclick="showReportForm()">
                        <i class="fas fa-plus"></i> New Report
                    </button>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="filterReports('all')">All Reports</div>
                    <div class="tab" onclick="filterReports('new')">New</div>
                    <div class="tab" onclick="filterReports('in-progress')">In Progress</div>
                    <div class="tab" onclick="filterReports('resolved')">Resolved</div>
                </div>

                <div id="reports-list" class="reports-list">
                    <!-- Reports will be loaded here -->
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="showDashboard()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Asset Details -->
    <div id="asset-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="report-detail-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeReportModal()">&times;</button>
            <div id="report-detail-content"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ================ GLOBAL VARIABLES ================
        let map;
        let userLocation = null;
        let uploadedImages = [];
        let reports = JSON.parse(localStorage.getItem('infrawatch_reports') || '[]');
        
        // Sample bridge data
        const sampleBridges = [
            {
                id: "B-101",
                name: "Downtown Artery Bridge",
                location: { lat: 40.7128, lng: -74.0060 },
                area: "Central District",
                age_years: 45,
                traffic_load_index: 88,
                heavy_vehicle_percentage: 32,
                incident_reports_count: 17,
                last_maintenance_date: "2015-03-15",
                flood_exposure_index: 75,
                heat_stress_index: 65,
                earthquake_zone_index: 40,
                fpi: 88,
                risk_category: "high"
            },
            {
                id: "B-102",
                name: "Northside Overpass",
                location: { lat: 40.7589, lng: -73.9851 },
                area: "North Industrial Area",
                age_years: 38,
                traffic_load_index: 95,
                heavy_vehicle_percentage: 28,
                incident_reports_count: 23,
                last_maintenance_date: "2013-08-22",
                flood_exposure_index: 30,
                heat_stress_index: 85,
                earthquake_zone_index: 25,
                fpi: 92,
                risk_category: "high"
            },
            {
                id: "B-103",
                name: "Rivercross Viaduct",
                location: { lat: 40.7549, lng: -73.9840 },
                area: "Riverside",
                age_years: 28,
                traffic_load_index: 70,
                heavy_vehicle_percentage: 18,
                incident_reports_count: 12,
                last_maintenance_date: "2019-11-10",
                flood_exposure_index: 85,
                heat_stress_index: 55,
                earthquake_zone_index: 65,
                fpi: 76,
                risk_category: "high"
            }
        ];

        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            initializeMap();
            setupEventListeners();
            loadReports();
        });

        // ================ VIEW MANAGEMENT ================
        function showDashboard() {
            document.getElementById('dashboard-view').style.display = 'block';
            document.getElementById('report-view').style.display = 'none';
            document.getElementById('reports-view').style.display = 'none';
        }

        function showReportForm() {
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('report-view').style.display = 'block';
            document.getElementById('reports-view').style.display = 'none';
            resetReportForm();
        }

        function showReportsList() {
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('report-view').style.display = 'none';
            document.getElementById('reports-view').style.display = 'block';
            displayReports('all');
        }

        // ================ DASHBOARD FUNCTIONS ================
        function updateDashboard() {
            updateStats();
            updateAssetList();
            updateRecommendation();
        }

        function updateStats() {
            const highRisk = sampleBridges.filter(b => b.fpi >= 70).length;
            const mediumRisk = sampleBridges.filter(b => b.fpi >= 40 && b.fpi < 70).length;
            const lowRisk = sampleBridges.filter(b => b.fpi < 40).length;
            const totalRisk = sampleBridges.reduce((sum, b) => sum + b.fpi, 0);
            
            document.getElementById('high-risk-count').textContent = highRisk;
            document.getElementById('medium-risk-count').textContent = mediumRisk;
            document.getElementById('low-risk-count').textContent = lowRisk;
            document.getElementById('total-risk').textContent = totalRisk;
        }

        function updateAssetList() {
            const assetList = document.getElementById('asset-list');
            let html = '';
            
            sampleBridges.forEach(bridge => {
                const riskClass = bridge.risk_category;
                const riskLabel = riskClass.charAt(0).toUpperCase() + riskClass.slice(1);
                
                html += `
                    <div class="asset-item ${riskClass}" onclick="showAssetDetails('${bridge.id}')">
                        <div class="asset-header">
                            <span class="asset-name">${bridge.name}</span>
                            <span class="risk-badge ${riskClass}">${riskLabel} Risk (${bridge.fpi})</span>
                        </div>
                        <div class="asset-details">
                            <span><i class="fas fa-map-marker-alt"></i> ${bridge.area}</span>
                            <span><i class="fas fa-calendar"></i> Age: ${bridge.age_years} years</span>
                            <span><i class="fas fa-car"></i> Traffic: ${bridge.traffic_load_index}/100</span>
                            <span><i class="fas fa-truck"></i> Trucks: ${bridge.heavy_vehicle_percentage}%</span>
                        </div>
                    </div>
                `;
            });
            
            assetList.innerHTML = html;
        }

        function updateRecommendation() {
            const budget = parseInt(document.getElementById('budget-slider').value);
            const sortedBridges = [...sampleBridges].sort((a, b) => b.fpi - a.fpi);
            const toRepair = sortedBridges.slice(0, budget);
            
            // Calculate risk reduction
            const currentTotalRisk = sampleBridges.reduce((sum, b) => sum + b.fpi, 0);
            const repairedBridges = sampleBridges.map(bridge => {
                if (toRepair.find(r => r.id === bridge.id)) {
                    return { ...bridge, fpi: 20 };
                }
                return bridge;
            });
            const newTotalRisk = repairedBridges.reduce((sum, b) => sum + b.fpi, 0);
            const riskReduction = ((currentTotalRisk - newTotalRisk) / currentTotalRisk * 100).toFixed(1);
            
            let repairList = '';
            toRepair.forEach(bridge => {
                repairList += `<li><strong>${bridge.name}</strong> (FPI: ${bridge.fpi})</li>`;
            });
            
            document.getElementById('recommendation').innerHTML = `
                <p>Fix these <strong>${budget}</strong> bridges first:</p>
                <ul style="margin: 10px 0 10px 20px;">
                    ${repairList}
                </ul>
                <div style="margin-top: 10px;">
                    <strong>Result:</strong> Reduce total network risk by <strong style="color: #059669;">${riskReduction}%</strong>
                </div>
            `;
        }

        function initializeMap() {
            map = L.map('map').setView([40.7128, -74.0060], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add bridge markers
            sampleBridges.forEach(bridge => {
                const riskClass = bridge.risk_category;
                const iconColor = riskClass === 'high' ? '#dc2626' : riskClass === 'medium' ? '#f59e0b' : '#059669';
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div style="
                            background: ${iconColor};
                            color: white;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                            border: 3px solid white;
                            font-weight: bold;
                        ">
                            <i class="fas fa-bridge"></i>
                            <div style="font-size: 10px;">${bridge.fpi}</div>
                        </div>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });
                
                const marker = L.marker([bridge.location.lat, bridge.location.lng], { icon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="padding: 10px; min-width: 200px;">
                            <h3 style="margin: 0 0 10px 0;">${bridge.name}</h3>
                            <p><strong>Risk:</strong> <span style="color: ${iconColor}; font-weight: bold;">${riskClass.toUpperCase()}</span></p>
                            <p><strong>FPI:</strong> ${bridge.fpi}/100</p>
                            <p><strong>Location:</strong> ${bridge.area}</p>
                            <button onclick="showAssetDetails('${bridge.id}')" style="
                                background: #2563eb;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                                margin-top: 10px;
                                width: 100%;
                            ">
                                View Details
                            </button>
                        </div>
                    `);
            });
            
            // Add reports markers
            addReportMarkersToMap();
        }

        // ================ REPORT SYSTEM FUNCTIONS ================
        function selectProblemType(element, type) {
            // Remove selection from all
            document.querySelectorAll('.problem-type').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to clicked
            element.classList.add('selected');
            document.getElementById('problem-type').value = type;
        }

        function getCurrentLocation() {
            const statusElement = document.getElementById('location-status');
            const latInput = document.getElementById('latitude');
            const lngInput = document.getElementById('longitude');
            
            statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting your location...';
            statusElement.style.color = '#d97706';
            
            if (!navigator.geolocation) {
                statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Geolocation is not supported by your browser';
                statusElement.style.color = '#dc2626';
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    latInput.value = userLocation.lat.toFixed(6);
                    lngInput.value = userLocation.lng.toFixed(6);
                    
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Location captured successfully!';
                    statusElement.style.color = '#059669';
                    
                    // Also update map if we're on dashboard
                    if (map && userLocation) {
                        L.marker([userLocation.lat, userLocation.lng])
                            .addTo(map)
                            .bindPopup('<strong>Your Current Location</strong><br>Reported from here')
                            .openPopup();
                        map.setView([userLocation.lat, userLocation.lng], 15);
                    }
                },
                function(error) {
                    console.error('Error getting location:', error);
                    statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Unable to get your location. Please enter manually.';
                    statusElement.style.color = '#dc2626';
                    
                    // Use default location for demo
                    userLocation = { lat: 40.7128, lng: -74.0060 };
                    latInput.value = userLocation.lat.toFixed(6);
                    lngInput.value = userLocation.lng.toFixed(6);
                }
            );
        }

        function handleImageUpload(event) {
            const files = event.target.files;
            const container = document.getElementById('image-preview-container');
            
            // Clear previous previews
            container.innerHTML = '';
            uploadedImages = [];
            
            for (let i = 0; i < Math.min(files.length, 5); i++) {
                const file = files[i];
                
                if (file.size > 5 * 1024 * 1024) {
                    alert(`Image ${file.name} is too large. Maximum size is 5MB.`);
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    uploadedImages.push({
                        url: imageUrl,
                        name: file.name,
                        type: file.type
                    });
                    
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview';
                    previewDiv.innerHTML = `
                        <img src="${imageUrl}" alt="Uploaded image">
                        <button class="remove-image" onclick="removeImage(${uploadedImages.length - 1})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            }
            
            // Reset file input
            event.target.value = '';
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreviews();
        }

        function updateImagePreviews() {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            
            uploadedImages.forEach((image, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                previewDiv.innerHTML = `
                    <img src="${image.url}" alt="Uploaded image">
                    <button class="remove-image" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(previewDiv);
            });
        }

        function resetReportForm() {
            document.getElementById('report-form').reset();
            document.querySelectorAll('.problem-type').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('image-preview-container').innerHTML = '';
            uploadedImages = [];
            userLocation = null;
            
            const latInput = document.getElementById('latitude');
            const lngInput = document.getElementById('longitude');
            latInput.value = '';
            lngInput.value = '';
            
            document.getElementById('location-status').innerHTML = 'Click "Get Location" to capture your current coordinates';
            document.getElementById('location-status').style.color = '#6b7280';
            
            document.getElementById('report-alert').innerHTML = '';
        }

        // ================ FORM SUBMISSION ================
        document.getElementById('report-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate required fields
            if (!document.getElementById('problem-type').value) {
                showAlert('Please select a problem type.', 'error');
                return;
            }
            
            if (!document.getElementById('location-name').value) {
                showAlert('Please enter a location name.', 'error');
                return;
            }
            
            if (!document.getElementById('description').value) {
                showAlert('Please describe the problem.', 'error');
                return;
            }
            
            if (!document.getElementById('user-name').value || !document.getElementById('user-email').value) {
                showAlert('Please provide your name and email.', 'error');
                return;
            }
            
            // Get form values
            const report = {
                id: 'RPT-' + Date.now(),
                problemType: document.getElementById('problem-type').value,
                locationName: document.getElementById('location-name').value,
                nearestLandmark: document.getElementById('nearest-landmark').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                description: document.getElementById('description').value,
                urgency: document.querySelector('input[name="urgency"]:checked').value,
                userName: document.getElementById('user-name').value,
                userEmail: document.getElementById('user-email').value,
                userPhone: document.getElementById('user-phone').value,
                userType: document.getElementById('user-type').value,
                images: uploadedImages,
                status: 'new',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Add to reports
            reports.unshift(report);
            saveReports();
            
            // Show success message
            showAlert('Report submitted successfully! Our team will review it shortly.', 'success');
            
            // Reset form
            resetReportForm();
            
            // Update map with new report
            addReportMarkersToMap();
            
            // Auto-switch to reports view after 2 seconds
            setTimeout(() => {
                showReportsList();
            }, 2000);
        });

        function showAlert(message, type) {
            const alertDiv = document.getElementById('report-alert');
            alertDiv.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;
        }

        // ================ REPORTS MANAGEMENT ================
        function saveReports() {
            localStorage.setItem('infrawatch_reports', JSON.stringify(reports));
        }

        function loadReports() {
            reports = JSON.parse(localStorage.getItem('infrawatch_reports') || '[]');
        }

        function displayReports(filter = 'all') {
            const container = document.getElementById('reports-list');
            let filteredReports = reports;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event?.target.classList.add('active');
            
            // Apply filter
            if (filter !== 'all') {
                filteredReports = reports.filter(report => report.status === filter);
            }
            
            if (filteredReports.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; color: #9ca3af;"></i>
                        <h3>No reports found</h3>
                        <p>${filter === 'all' ? 'Submit your first report!' : 'No ' + filter.replace('-', ' ') + ' reports'}</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredReports.forEach(report => {
                const statusClass = `status-${report.status.replace('-', '')}`;
                const statusText = report.status.charAt(0).toUpperCase() + report.status.slice(1);
                const date = new Date(report.createdAt).toLocaleDateString();
                
                html += `
                    <div class="report-item" onclick="showReportDetails('${report.id}')">
                        <div class="report-header">
                            <div class="report-title">${report.locationName}</div>
                            <span class="report-status ${statusClass}">${statusText}</span>
                        </div>
                        <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 10px;">
                            <i class="fas fa-${getProblemIcon(report.problemType)}"></i>
                            ${getProblemTypeText(report.problemType)} • 
                            <i class="fas fa-clock"></i> ${date}
                        </div>
                        <p style="color: #4b5563; font-size: 0.95rem; margin-bottom: 10px;">
                            ${report.description.substring(0, 150)}${report.description.length > 150 ? '...' : ''}
                        </p>
                        <div class="user-info">
                            <div class="user-avatar">${report.userName.charAt(0).toUpperCase()}</div>
                            <div>
                                <div style="font-weight: 600;">${report.userName}</div>
                                <div style="font-size: 0.85rem; color: #6b7280;">${report.userType}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function filterReports(filter) {
            displayReports(filter);
        }

        function getProblemIcon(type) {
            const icons = {
                'pothole': 'road',
                'crack': 'crack',
                'flooding': 'water',
                'safety': 'triangle-exclamation',
                'maintenance': 'tools',
                'other': 'ellipsis'
            };
            return icons[type] || 'exclamation-circle';
        }

        function getProblemTypeText(type) {
            const texts = {
                'pothole': 'Potholes',
                'crack': 'Cracks & Damage',
                'flooding': 'Flooding Issues',
                'safety': 'Safety Hazard',
                'maintenance': 'Maintenance Needed',
                'other': 'Other Issue'
            };
            return texts[type] || 'Unknown Issue';
        }

        function showReportDetails(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            const content = document.getElementById('report-detail-content');
            const modal = document.getElementById('report-detail-modal');
            
            let imagesHtml = '';
            if (report.images && report.images.length > 0) {
                imagesHtml = `
                    <h3 style="margin: 20px 0 10px 0; color: #1f2937;">📸 Uploaded Images</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        ${report.images.map(img => `
                            <div style="border-radius: 8px; overflow: hidden; height: 150px;">
                                <img src="${img.url}" alt="Report image" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            content.innerHTML = `
                <h2 style="color: #1f2937; margin-bottom: 10px;">${report.locationName}</h2>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <span class="report-status status-${report.status.replace('-', '')}" style="font-size: 0.9rem; padding: 6px 12px;">
                        ${report.status.charAt(0).toUpperCase() + report.status.slice(1)}
                    </span>
                    <span><i class="fas fa-calendar"></i> ${new Date(report.createdAt).toLocaleString()}</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937;">📋 Problem Details</h3>
                        <p><strong>Type:</strong> ${getProblemTypeText(report.problemType)}</p>
                        <p><strong>Urgency:</strong> <span style="color: ${
                            report.urgency === 'high' ? '#dc2626' : report.urgency === 'medium' ? '#d97706' : '#059669'
                        };">${report.urgency.toUpperCase()}</span></p>
                        <p><strong>Location:</strong> ${report.nearestLandmark || 'No landmark specified'}</p>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937;">📍 Coordinates</h3>
                        <p><strong>Latitude:</strong> ${report.latitude}</p>
                        <p><strong>Longitude:</strong> ${report.longitude}</p>
                        <button onclick="showOnMap(${report.latitude}, ${report.longitude})" style="
                            background: #2563eb;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            margin-top: 10px;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        ">
                            <i class="fas fa-map"></i> View on Map
                        </button>
                    </div>
                </div>
                
                <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #1f2937;">📝 Description</h3>
                    <p>${report.description}</p>
                </div>
                
                ${imagesHtml}
                
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #1f2937;">👤 Reporter Information</h3>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="user-avatar" style="width: 50px; height: 50px; font-size: 1.2rem;">
                            ${report.userName.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div style="font-weight: 600; font-size: 1.1rem;">${report.userName}</div>
                            <div style="color: #6b7280;">${report.userEmail}</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">
                                ${report.userPhone ? `📞 ${report.userPhone} • ` : ''}
                                👤 ${report.userType}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button onclick="updateReportStatus('${report.id}', 'in-progress')" style="
                        background: #f59e0b;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                    ">
                        <i class="fas fa-play"></i> Mark as In Progress
                    </button>
                    <button onclick="updateReportStatus('${report.id}', 'resolved')" style="
                        background: #059669;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                    ">
                        <i class="fas fa-check"></i> Mark as Resolved
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function closeReportModal() {
            document.getElementById('report-detail-modal').style.display = 'none';
        }

        function updateReportStatus(reportId, status) {
            const reportIndex = reports.findIndex(r => r.id === reportId);
            if (reportIndex !== -1) {
                reports[reportIndex].status = status;
                reports[reportIndex].updatedAt = new Date().toISOString();
                saveReports();
                displayReports(document.querySelector('.tab.active').onclick.name || 'all');
                closeReportModal();
                
                alert(`Report marked as ${status.replace('-', ' ')}!`);
            }
        }

        function addReportMarkersToMap() {
            // Clear existing report markers
            if (window.reportMarkers) {
                window.reportMarkers.forEach(marker => map.removeLayer(marker));
            }
            window.reportMarkers = [];
            
            // Add markers for each report with location
            reports.forEach(report => {
                if (report.latitude && report.longitude) {
                    const icon = L.divIcon({
                        className: 'report-marker',
                        html: `
                            <div style="
                                background: ${
                                    report.status === 'new' ? '#2563eb' : 
                                    report.status === 'in-progress' ? '#f59e0b' : 
                                    '#059669'
                                };
                                color: white;
                                width: 35px;
                                height: 35px;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                                border: 3px solid white;
                                font-weight: bold;
                            ">
                                <i class="fas fa-exclamation"></i>
                            </div>
                        `,
                        iconSize: [35, 35],
                        iconAnchor: [17.5, 35]
                    });
                    
                    const marker = L.marker([parseFloat(report.latitude), parseFloat(report.longitude)], { icon })
                        .addTo(map)
                        .bindPopup(`
                            <div style="padding: 10px; min-width: 200px;">
                                <h3 style="margin: 0 0 10px 0;">${report.locationName}</h3>
                                <p><strong>Status:</strong> <span style="color: ${
                                    report.status === 'new' ? '#2563eb' : 
                                    report.status === 'in-progress' ? '#f59e0b' : 
                                    '#059669'
                                };">${report.status.toUpperCase()}</span></p>
                                <p><strong>Type:</strong> ${getProblemTypeText(report.problemType)}</p>
                                <p>${report.description.substring(0, 100)}...</p>
                                <button onclick="showReportDetails('${report.id}')" style="
                                    background: #2563eb;
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    margin-top: 10px;
                                    width: 100%;
                                ">
                                    View Details
                                </button>
                            </div>
                        `);
                    
                    window.reportMarkers.push(marker);
                }
            });
        }

        function showOnMap(lat, lng) {
            closeReportModal();
            showDashboard();
            
            map.setView([lat, lng], 15);
            
            // Add a highlighted marker
            L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'highlight-marker',
                    html: `<div style="
                        background: #dc2626;
                        color: white;
                        width: 45px;
                        height: 45px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
                        border: 3px solid white;
                        font-weight: bold;
                        animation: pulse 1.5s infinite;
                    ">
                        <i class="fas fa-map-pin"></i>
                    </div>`,
                    iconSize: [45, 45],
                    iconAnchor: [22.5, 45]
                })
            }).addTo(map).bindPopup('<strong>Report Location</strong>').openPopup();
            
            // Add CSS for pulse animation
            if (!document.querySelector('#pulse-animation')) {
                const style = document.createElement('style');
                style.id = 'pulse-animation';
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); opacity: 1; }
                        50% { transform: scale(1.1); opacity: 0.8; }
                        100% { transform: scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ================ ASSET DETAILS MODAL ================
        function showAssetDetails(bridgeId) {
            const bridge = sampleBridges.find(b => b.id === bridgeId);
            if (!bridge) return;
            
            const riskClass = bridge.risk_category;
            const riskLabel = riskClass.charAt(0).toUpperCase() + riskClass.slice(1);
            
            const modalContent = document.getElementById('modal-content');
            const modal = document.getElementById('asset-modal');
            
            modalContent.innerHTML = `
                <h2>${bridge.name}</h2>
                <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
                    <span class="risk-badge ${riskClass}" style="font-size: 1rem; padding: 8px 16px;">
                        ${riskLabel} RISK (FPI: ${bridge.fpi}/100)
                    </span>
                    <span><i class="fas fa-map-marker-alt"></i> ${bridge.area}</span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937;">📊 Structural Risk</h3>
                        <p><strong>Age:</strong> ${bridge.age_years} years</p>
                        <p><strong>Last Maintenance:</strong> ${bridge.last_maintenance_date}</p>
                        <p><strong>Incident Reports:</strong> ${bridge.incident_reports_count}</p>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937;">🚗 Usage Stress</h3>
                        <p><strong>Traffic Load:</strong> ${bridge.traffic_load_index}/100</p>
                        <p><strong>Heavy Vehicles:</strong> ${bridge.heavy_vehicle_percentage}%</p>
                        <p><strong>Daily Stress:</strong> High</p>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937;">🌍 Environmental Risk</h3>
                        <p><strong>Flood Risk:</strong> ${bridge.flood_exposure_index}/100</p>
                        <p><strong>Heat Stress:</strong> ${bridge.heat_stress_index}/100</p>
                        <p><strong>Seismic Risk:</strong> ${bridge.earthquake_zone_index}/100</p>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f2937;">🎯 Risk Score</h3>
                        <div style="font-size: 2.5rem; font-weight: bold; text-align: center; color: ${
                            riskClass === 'high' ? '#dc2626' : riskClass === 'medium' ? '#f59e0b' : '#059669'
                        };">
                            ${bridge.fpi}/100
                        </div>
                        <p style="text-align: center; margin-top: 5px;">Failure Probability Index</p>
                    </div>
                </div>
                
                <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="margin: 0 0 10px 0; color: #1f2937;">📋 Risk Explanation</h3>
                    <p>${generateDetailedReason(bridge)}</p>
                </div>
                
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0 0 10px 0; color: #1f2937;">🔧 Recommended Actions</h3>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>Immediate structural inspection required</li>
                        <li>Schedule priority maintenance within 30 days</li>
                        <li>Consider temporary traffic diversion</li>
                        <li>Monitor environmental conditions closely</li>
                    </ul>
                </div>
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button onclick="showReportFormForBridge('${bridge.name}')" class="btn btn-secondary" style="width: auto;">
                        <i class="fas fa-exclamation-circle"></i> Report Problem at this Location
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function showReportFormForBridge(bridgeName) {
            closeModal();
            showReportForm();
            
            document.getElementById('location-name').value = bridgeName;
            document.getElementById('location-name').focus();
        }

        function closeModal() {
            document.getElementById('asset-modal').style.display = 'none';
        }

        function generateDetailedReason(bridge) {
            const reasons = [];
            
            if (bridge.age_years > 40) reasons.push(`Structure is ${bridge.age_years} years old`);
            
            const lastMaintenance = new Date(bridge.last_maintenance_date);
            const gapYears = (new Date() - lastMaintenance) / (1000 * 60 * 60 * 24 * 365.25);
            if (gapYears > 5) reasons.push(`${gapYears.toFixed(1)} years since last maintenance`);
            
            if (bridge.traffic_load_index > 70) reasons.push(`Heavy daily traffic (${bridge.traffic_load_index}/100)`);
            if (bridge.heavy_vehicle_percentage > 20) reasons.push(`High percentage of heavy vehicles (${bridge.heavy_vehicle_percentage}%)`);
            if (bridge.incident_reports_count > 10) reasons.push(`Multiple incident reports (${bridge.incident_reports_count})`);
            if (bridge.flood_exposure_index > 60) reasons.push(`Located in flood-prone area (${bridge.flood_exposure_index}/100)`);
            if (bridge.heat_stress_index > 70) reasons.push(`Exposed to heat stress (${bridge.heat_stress_index}/100)`);
            if (bridge.earthquake_zone_index > 50) reasons.push(`Seismic risk zone (${bridge.earthquake_zone_index}/100)`);
            
            return reasons.length > 0 
                ? `High risk due to: ${reasons.join('. ')}.`
                : 'Risk factors are within acceptable ranges.';
        }

        // ================ EVENT LISTENERS ================
        function setupEventListeners() {
            // Budget slider
            document.getElementById('budget-slider').addEventListener('input', function(e) {
                document.getElementById('budget-value').textContent = e.target.value;
                updateRecommendation();
            });
            
            // Simulate button
            document.getElementById('simulate-btn').addEventListener('click', function() {
                const budget = parseInt(document.getElementById('budget-slider').value);
                const sortedBridges = [...sampleBridges].sort((a, b) => b.fpi - a.fpi);
                const toRepair = sortedBridges.slice(0, budget);
                
                let bridgeNames = toRepair.map(b => b.name).join(', ');
                alert(`🎯 AI Simulation Complete!\n\nRecommended to fix: ${bridgeNames}\n\nThis will significantly reduce overall infrastructure risk and prevent potential failures.`);
            });
        }
    </script>
</body>
</html>